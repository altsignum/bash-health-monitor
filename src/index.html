<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Health Monitor</title>
    <style>
      :root {
        --bg: #0b0d12;
        --card: #121622;
        --text: #e7e9ee;
        --muted: #aab0bf;
        --line: #242a3a;

        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
        --stopped: #64748b;

        --link: #8ab4ff;
      }

      * { box-sizing: border-box; }

      html { height: 100%; }

      body {
        margin: 0;
        font: 14px/1.4 ui-sans-serif, system-ui, -apple-system,
          Segoe UI, Roboto, Helvetica, Arial;
        background: radial-gradient(1200px 600px at 20% -10%,
          rgba(138,180,255,0.18), transparent 60%),
          radial-gradient(900px 500px at 110% 10%,
          rgba(34,197,94,0.12), transparent 55%),
          var(--bg);
        color: var(--text);
      }

      .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 24px 16px 40px;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
        margin-bottom: 16px;
      }

      h1 {
        margin: 0;
        font-size: 18px;
      }

      .header-right {
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .sub {
        font-size: 12px;
        color: var(--muted);
      }

      .icon-btn {
        width: 26px;
        height: 26px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.03);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        cursor: pointer;
        padding: 0;
      }

      .icon-btn:hover {
        border-color: rgba(255,255,255,0.16);
        background: rgba(255,255,255,0.05);
        color: var(--text);
      }

      .icon-btn:disabled {
        cursor: default;
        opacity: 0.9;
      }

      .icon {
        width: 16px;
        height: 16px;
        display: block;
      }

      .spin {
        animation: spin 0.8s linear infinite;
      }

      .card {
        background: linear-gradient(180deg,
          rgba(18,22,34,0.92),
          rgba(18,22,34,0.78));
        border: 1px solid var(--line);
        border-radius: 12px;
        overflow: hidden;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th, td {
        padding: 12px;
        border-bottom: 1px solid var(--line);
        white-space: nowrap;
      }

      th {
        text-align: left;
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
      }

      tr:last-child td { border-bottom: none; }

      .svc {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }

      .dot.stable { background: var(--ok); }
      .dot.unstable { background: var(--warn); }
      .dot.failed { background: var(--bad); }
      .dot.stopped { background: var(--stopped); }
      .dot.completed { background: var(--ok); }
      .dot.transition { background: var(--warn); }

      .badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid rgba(255,255,255,0.08);
        background: rgba(255,255,255,0.03);
      }

      .badge.stable {
        background: rgba(34,197,94,0.10);
        border-color: rgba(34,197,94,0.35);
      }

      .badge.unstable {
        background: rgba(245,158,11,0.10);
        border-color: rgba(245,158,11,0.35);
      }

      .badge.failed {
        background: rgba(239,68,68,0.10);
        border-color: rgba(239,68,68,0.35);
      }

      .badge.stopped {
        background: rgba(100,116,139,0.10);
        border-color: rgba(100,116,139,0.35);
      }

      .badge.completed {
        background: rgba(34,197,94,0.10);
        border-color: rgba(34,197,94,0.35);
      }

      .badge.transition {
        background: rgba(245,158,11,0.10);
        border-color: rgba(245,158,11,0.35);
      }

      .muted { color: var(--muted); }

      a {
        color: var(--link);
        text-decoration: none;
      }

      a:hover { text-decoration: underline; }

      .copy {
        color: var(--link);
        cursor: pointer;
      }

      .loading-cell {
        padding: 18px 12px;
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        color: var(--muted);
        font-size: 12px;
      }

      .spinner {
        width: 14px;
        height: 14px;
        border-radius: 999px;
        border: 2px solid rgba(170,176,191,0.25);
        border-top-color: rgba(170,176,191,0.95);
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Health Monitor</h1>

        <div class="header-right">
          <div class="sub" id="lastRefresh">Last refresh: --</div>

          <button class="icon-btn" id="refreshBtn" type="button"
            aria-label="Refresh">
            <svg class="icon" id="refreshIcon" viewBox="0 0 24 24"
              fill="none" aria-hidden="true">
              <path
                d="M20 12a8 8 0 1 1-2.343-5.657"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
              />
              <path
                d="M20 4v6h-6"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </button>
        </div>
      </header>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Service</th>
              <th>Status</th>
              <th>Active Since</th>
              <th>Host</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr>
              <td class="loading-cell" colspan="5">
                <div class="loading">
                  <span class="spinner" aria-hidden="true"></span>
                  <span>Loading...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      (function () {
        "use strict";

        const $rows = document.getElementById("rows");
        const $lastRefresh = document.getElementById("lastRefresh");
        const $refreshBtn = document.getElementById("refreshBtn");
        const $refreshIcon = document.getElementById("refreshIcon");

        let isLoadedOnce = false;
        let isRefreshing = false;

        /* ===================== API helper ===================== */

        function getSelfRoot() {
          let root = window.location.origin +
            window.location.pathname.replace(/\/[^\/]*$/, "");

          if (!root.endsWith("/")) root += "/";
          return root;
        }

        function buildApiUrl(base, path) {
          const selfRoot = getSelfRoot();

          if (path.startsWith("/")) path = path.slice(1);

          if (base === "__self__") {
            return selfRoot + path;
          }

          const u = new URL(selfRoot + path);
          u.searchParams.set("monitor", String(base));
          return u.toString();
        }

        async function apiJson(base, path, timeoutMs = 5000) {
          const url = buildApiUrl(base, path);

          const ac = new AbortController();
          const t = setTimeout(() => ac.abort(), timeoutMs);

          try {
            const res = await fetch(url, {
              signal: ac.signal,
              cache: "no-store"
            });

            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.json();
          } finally {
            clearTimeout(t);
          }
        }

        /* ===================== UI helpers ===================== */

        function escapeHtml(s) {
          return String(s)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll("\"", "&quot;")
            .replaceAll("'", "&#39;");
        }

        async function copyText(text) {
          const value = String(text ?? "");
          if (!value) return;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(value);
            return;
          }

          const ta = document.createElement("textarea");
          ta.value = value;
          ta.setAttribute("readonly", "");
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
        }

        function renderRow(item) {
          const name = escapeHtml(item.name);
          const status = escapeHtml(item.status);
          const host = escapeHtml(item.host);
          const timestamp = item.activeSince
            ? new Date(item.activeSince).toLocaleString()
            : '--';
          const activeSince = `<span class="muted">${timestamp}</span>`;

          const details = item.status === "unstable" &&
            typeof item.errorCount === "number"
            ? `<a href="errors?service=${item.name}&format=text"
                target="_blank">
                Errors (${item.errorCount})
              </a>`
            : `<span class="muted">--</span>`;

          return `
            <tr>
              <td>
                <div class="svc">
                  <span class="dot ${status}" aria-hidden="true"></span>
                  <span class="copy"
                    title="Click to copy"
                    data-action="copy"
                    data-copy="${name}">${name}</span>
                </div>
              </td>
              <td><span class="badge ${status}">${status}</span></td>
              <td>${activeSince}</td>
              <td class="muted">
                <span class="copy"
                  title="Click to copy"
                  data-action="copy"
                  data-copy="${host}">${host}</span>
              </td>
              <td>${details}</td>
            </tr>
          `.trim();
        }

        function renderTable(items) {
          $rows.innerHTML = items.map(renderRow).join("");
          $lastRefresh.textContent =
            `Last refresh: ${new Date().toLocaleString()}`;
          isLoadedOnce = true;
        }

        function setRefreshing(flag) {
          isRefreshing = flag;
          $refreshBtn.disabled = flag;
          $refreshIcon.classList.toggle("spin", flag);
        }

        /* ===================== Data loading ===================== */

        async function loadData() {
          const self = "__self__";

          const uniq = (arr) => {
            const seen = new Set();
            const out = [];
            for (const x of arr) {
              const v = String(x || "").trim().replace(/\/+$/, "");
              if (!v) continue;
              if (seen.has(v)) continue;
              seen.add(v);
              out.push(v);
            }
            return out;
          };

          let external = [];
          try {
            external = await apiJson(self, "/monitors", 4000);
            if (!Array.isArray(external)) external = [];
          } catch {
            external = [];
          }

          const monitors = uniq([self, ...external]);

          const hostByMonitor = new Map();
          for (const monitorBase of monitors) {
            try {
              const hostRes = await apiJson(monitorBase, "/host", 4000);
              const hostValue = hostRes && typeof hostRes.host === "string"
                ? hostRes.host
                : "";
              hostByMonitor.set(monitorBase, hostValue || "");
            } catch {
              hostByMonitor.set(monitorBase, "");
            }
          }

          const items = [];

          for (const monitorBase of monitors) {
            let services = [];
            try {
              services = await apiJson(monitorBase, "/list", 4000);
              if (!Array.isArray(services)) services = [];
            } catch {
              services = [];
            }

            const monitorHost = hostByMonitor.get(monitorBase) || "";

            for (const svc of services) {
              let st = { status: "failed" };

              try {
                st = await apiJson(
                  monitorBase,
                  `/status?service=${encodeURIComponent(svc)}`,
                  5000
                );
              } catch {
                st = { status: "failed" };
              }

              const status = String(st.status || "failed");

              const row = {
                name: svc,
                status,
                host: monitorHost,
                base: monitorBase
              };

              if (typeof st.activeSince === "string" &&
                  st.activeSince.trim()) {
                row.activeSince = st.activeSince;
              }

              if (status === "unstable" &&
                  typeof st.errorCount === "number") {
                row.errorCount = st.errorCount;
              }

              items.push(row);
            }
          }

          return items;
        }

        /* ===================== Refresh ===================== */

        async function refresh() {
          if (isRefreshing) return;

          setRefreshing(true);
          try {
            const data = await loadData();
            renderTable(data);
          } finally {
            setRefreshing(false);
          }
        }

        $refreshBtn.addEventListener("click", refresh);

        (async function init() {
          await refresh();
          setInterval(refresh, 60 * 1000);
        })();
      })();
    </script>

  </body>
</html>
